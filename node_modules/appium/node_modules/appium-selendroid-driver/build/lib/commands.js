'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _utf7 = require('utf7');

var _utf72 = _interopRequireDefault(_utf7);

var _appiumAndroidDriver = require('appium-android-driver');

var imap = _utf72['default'].imap;

var extensions = {},
    commands = {},
    helpers = {};

commands.launchApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};
commands.reset = function callee$0$0() {
  var oldImpWait, oldCommandTimeoutMs, oldSessionId;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Running generic full reset");
        oldImpWait = this.implicitWaitMs;
        oldCommandTimeoutMs = this.commandTimeoutMs;
        oldSessionId = this.sessionId;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.deleteSession());

      case 6:
        _logger2['default'].debug("Restarting app");
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 9:
        this.implicitWait(oldImpWait);
        this.timeouts('command', oldCommandTimeoutMs);
        this.sessionId = oldSessionId;

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performMultiAction = function callee$0$0(elId, actions) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!elId) {
          context$1$0.next = 2;
          break;
        }

        throw new Error("Selendroid actions do not support element id");

      case 2:
        return context$1$0.abrupt('return', this.selendroid.jwproxy.command('/action', 'POST', { payload: actions }));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function encodeString(value, unicode) {
  for (var i = 0; i < value.length; i++) {
    var c = value.charCodeAt(i);
    // if we're using the unicode keyboard, and this is unicode, maybe encode
    if (unicode && (c > 127 || c === 38)) {
      // this is not simple ascii, or it is an ampersand (`&`)
      if (c >= parseInt("E000", 16) && c <= parseInt("E040", 16)) {
        // Selenium uses a Unicode PUA to cover certain special characters
        // see https://code.google.com/p/selenium/source/browse/java/client/src/org/openqa/selenium/Keys.java
      } else {
          // encode the text
          value = imap.encode(value);
          break;
        }
    }
  }
  return value;
}

// Need to override this for correct unicode support
commands.setValue = function callee$0$0(value, elementId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text on element \'' + elementId + '\': \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/element/' + elementId + '/value', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Need to override this for correct unicode support
commands.keys = function callee$0$0(value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text: \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/keys', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Selendroid doesn't support metastate for keyevents
commands.keyevent = function callee$0$0(keycode, metastate) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Ignoring metastate ' + metastate);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.adb.keyevent(keycode));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Use ADB since we don't have UiAutomator
commands.back = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.adb.keyevent(4));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var chromiumViews, webviews, selendroidViews;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        chromiumViews = [];
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumAndroidDriver.webviewHelpers.getWebviews(this.adb, this.opts.androidDeviceSocket));

      case 3:
        webviews = context$1$0.sent;

        if (_lodash2['default'].contains(webviews, _appiumAndroidDriver.CHROMIUM_WIN)) {
          chromiumViews = [_appiumAndroidDriver.CHROMIUM_WIN];
        } else {
          chromiumViews = [];
        }

        _logger2['default'].info('Getting window handles from Selendroid');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window_handles', 'GET', {}));

      case 8:
        selendroidViews = context$1$0.sent;

        this.contexts = _lodash2['default'].union(selendroidViews, chromiumViews);
        _logger2['default'].info('Available contexts: ' + JSON.stringify(this.contexts));
        return context$1$0.abrupt('return', this.contexts);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.switchContext = function callee$0$0(name) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window', 'POST', { name: name }));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isChromedriverContext = function (windowName) {
  return windowName === _appiumAndroidDriver.CHROMIUM_WIN;
};

_Object$assign(extensions, commands, helpers);

exports['default'] = extensions;
module.exports = exports['default'];

// called when setting context
//# sourceMappingURL=data:application/json;base64,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RyxFQUFFLENBQUM7U0FDcEI7O0FBRUQsNEJBQUksSUFBSSxDQUFDLHdDQUF3QyxDQUFDLENBQUM7O3lDQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQzs7O0FBQXJGLHVCQUFlOztBQUNuQixZQUFJLENBQUMsUUFBUSxHQUFHLG9CQUFFLEtBQUssQ0FBQyxlQUFlLEVBQUUsYUFBYSxDQUFDLENBQUM7QUFDeEQsNEJBQUksSUFBSSwwQkFBd0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUcsQ0FBQzs0Q0FDMUQsSUFBSSxDQUFDLFFBQVE7Ozs7Ozs7Q0FDckIsQ0FBQzs7QUFFRixPQUFPLENBQUMsYUFBYSxHQUFHLG9CQUFnQixJQUFJOzs7Ozt5Q0FFcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsRUFBQyxJQUFJLEVBQUosSUFBSSxFQUFDLENBQUM7Ozs7Ozs7Q0FDakUsQ0FBQzs7QUFFRixPQUFPLENBQUMscUJBQXFCLEdBQUcsVUFBVSxVQUFVLEVBQUU7QUFDcEQsU0FBTyxVQUFVLHNDQUFpQixDQUFDO0NBQ3BDLENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDOztxQkFFOUIsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgdXRmNyBmcm9tICd1dGY3JztcbmltcG9ydCB7IHdlYnZpZXdIZWxwZXJzLCBDSFJPTUlVTV9XSU4gfSBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuXG5jb25zdCB7aW1hcH0gPSB1dGY3O1xuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9LFxuICAgIGNvbW1hbmRzID0ge30sXG4gICAgaGVscGVycyA9IHt9O1xuXG5jb21tYW5kcy5sYXVuY2hBcHAgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGF3YWl0IHRoaXMuc3RhcnRTZWxlbmRyb2lkU2Vzc2lvbigpO1xufTtcbmNvbW1hbmRzLnJlc2V0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2cuZGVidWcoXCJSdW5uaW5nIGdlbmVyaWMgZnVsbCByZXNldFwiKTtcbiAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICBsZXQgb2xkQ29tbWFuZFRpbWVvdXRNcyA9IHRoaXMuY29tbWFuZFRpbWVvdXRNcztcbiAgbGV0IG9sZFNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuXG4gIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICBsb2cuZGVidWcoXCJSZXN0YXJ0aW5nIGFwcFwiKTtcbiAgYXdhaXQgdGhpcy5zdGFydFNlbGVuZHJvaWRTZXNzaW9uKCk7XG4gIHRoaXMuaW1wbGljaXRXYWl0KG9sZEltcFdhaXQpO1xuICB0aGlzLnRpbWVvdXRzKCdjb21tYW5kJywgb2xkQ29tbWFuZFRpbWVvdXRNcyk7XG4gIHRoaXMuc2Vzc2lvbklkID0gb2xkU2Vzc2lvbklkO1xufTtcblxuY29tbWFuZHMucGVyZm9ybU11bHRpQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGVsSWQsIGFjdGlvbnMpIHtcbiAgaWYgKGVsSWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJTZWxlbmRyb2lkIGFjdGlvbnMgZG8gbm90IHN1cHBvcnQgZWxlbWVudCBpZFwiKTtcbiAgfVxuICByZXR1cm4gdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL2FjdGlvbicsICdQT1NUJywge3BheWxvYWQ6IGFjdGlvbnN9KTtcbn07XG5cbmZ1bmN0aW9uIGVuY29kZVN0cmluZyAodmFsdWUsIHVuaWNvZGUpIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgIGxldCBjID0gdmFsdWUuY2hhckNvZGVBdChpKTtcbiAgICAvLyBpZiB3ZSdyZSB1c2luZyB0aGUgdW5pY29kZSBrZXlib2FyZCwgYW5kIHRoaXMgaXMgdW5pY29kZSwgbWF5YmUgZW5jb2RlXG4gICAgaWYgKHVuaWNvZGUgJiYgKGMgPiAxMjcgfHwgYyA9PT0gMzgpKSB7XG4gICAgICAvLyB0aGlzIGlzIG5vdCBzaW1wbGUgYXNjaWksIG9yIGl0IGlzIGFuIGFtcGVyc2FuZCAoYCZgKVxuICAgICAgaWYgKGMgPj0gcGFyc2VJbnQoXCJFMDAwXCIsIDE2KSAmJiBjIDw9IHBhcnNlSW50KFwiRTA0MFwiLCAxNikpIHtcbiAgICAgICAgLy8gU2VsZW5pdW0gdXNlcyBhIFVuaWNvZGUgUFVBIHRvIGNvdmVyIGNlcnRhaW4gc3BlY2lhbCBjaGFyYWN0ZXJzXG4gICAgICAgIC8vIHNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL3NlbGVuaXVtL3NvdXJjZS9icm93c2UvamF2YS9jbGllbnQvc3JjL29yZy9vcGVucWEvc2VsZW5pdW0vS2V5cy5qYXZhXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBlbmNvZGUgdGhlIHRleHRcbiAgICAgICAgdmFsdWUgPSBpbWFwLmVuY29kZSh2YWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gdmFsdWU7XG59XG5cbi8vIE5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBmb3IgY29ycmVjdCB1bmljb2RlIHN1cHBvcnRcbmNvbW1hbmRzLnNldFZhbHVlID0gYXN5bmMgZnVuY3Rpb24gKHZhbHVlLCBlbGVtZW50SWQpIHtcbiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICB2YWx1ZSA9IHZhbHVlLmpvaW4oXCJcIik7XG4gIH1cbiAgbG9nLmRlYnVnKGBTZXR0aW5nIHRleHQgb24gZWxlbWVudCAnJHtlbGVtZW50SWR9JzogJyR7dmFsdWV9J2ApO1xuICB2YWx1ZSA9IGVuY29kZVN0cmluZyh2YWx1ZSwgdGhpcy5vcHRzLnVuaWNvZGVLZXlib2FyZCk7XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoYC9lbGVtZW50LyR7ZWxlbWVudElkfS92YWx1ZWAsICdQT1NUJywge3ZhbHVlOiBbdmFsdWVdfSk7XG59O1xuXG4vLyBOZWVkIHRvIG92ZXJyaWRlIHRoaXMgZm9yIGNvcnJlY3QgdW5pY29kZSBzdXBwb3J0XG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24gKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgdmFsdWUgPSB2YWx1ZS5qb2luKFwiXCIpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgU2V0dGluZyB0ZXh0OiAnJHt2YWx1ZX0nYCk7XG4gIHZhbHVlID0gZW5jb2RlU3RyaW5nKHZhbHVlLCB0aGlzLm9wdHMudW5pY29kZUtleWJvYXJkKTtcbiAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL2tleXMnLCAnUE9TVCcsIHt2YWx1ZTogW3ZhbHVlXX0pO1xufTtcblxuLy8gU2VsZW5kcm9pZCBkb2Vzbid0IHN1cHBvcnQgbWV0YXN0YXRlIGZvciBrZXlldmVudHNcbmNvbW1hbmRzLmtleWV2ZW50ID0gYXN5bmMgZnVuY3Rpb24gKGtleWNvZGUsIG1ldGFzdGF0ZSkge1xuICBsb2cuZGVidWcoYElnbm9yaW5nIG1ldGFzdGF0ZSAke21ldGFzdGF0ZX1gKTtcbiAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoa2V5Y29kZSk7XG59O1xuXG4vLyBVc2UgQURCIHNpbmNlIHdlIGRvbid0IGhhdmUgVWlBdXRvbWF0b3JcbmNvbW1hbmRzLmJhY2sgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGF3YWl0IHRoaXMuYWRiLmtleWV2ZW50KDQpO1xufTtcblxuY29tbWFuZHMuZ2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBjaHJvbWl1bVZpZXdzID0gW107XG4gIGxldCB3ZWJ2aWV3cyA9IGF3YWl0IHdlYnZpZXdIZWxwZXJzLmdldFdlYnZpZXdzKHRoaXMuYWRiLFxuICAgICAgdGhpcy5vcHRzLmFuZHJvaWREZXZpY2VTb2NrZXQpO1xuICBpZiAoXy5jb250YWlucyh3ZWJ2aWV3cywgQ0hST01JVU1fV0lOKSkge1xuICAgIGNocm9taXVtVmlld3MgPSBbQ0hST01JVU1fV0lOXTtcbiAgfSBlbHNlIHtcbiAgICBjaHJvbWl1bVZpZXdzID0gW107XG4gIH1cblxuICBsb2cuaW5mbygnR2V0dGluZyB3aW5kb3cgaGFuZGxlcyBmcm9tIFNlbGVuZHJvaWQnKTtcbiAgbGV0IHNlbGVuZHJvaWRWaWV3cyA9IGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy93aW5kb3dfaGFuZGxlcycsICdHRVQnLCB7fSk7XG4gIHRoaXMuY29udGV4dHMgPSBfLnVuaW9uKHNlbGVuZHJvaWRWaWV3cywgY2hyb21pdW1WaWV3cyk7XG4gIGxvZy5pbmZvKGBBdmFpbGFibGUgY29udGV4dHM6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5jb250ZXh0cyl9YCk7XG4gIHJldHVybiB0aGlzLmNvbnRleHRzO1xufTtcblxuaGVscGVycy5zd2l0Y2hDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUpIHtcbiAgLy8gY2FsbGVkIHdoZW4gc2V0dGluZyBjb250ZXh0XG4gIGF3YWl0IHRoaXMuc2VsZW5kcm9pZC5qd3Byb3h5LmNvbW1hbmQoJy93aW5kb3cnLCAnUE9TVCcsIHtuYW1lfSk7XG59O1xuXG5oZWxwZXJzLmlzQ2hyb21lZHJpdmVyQ29udGV4dCA9IGZ1bmN0aW9uICh3aW5kb3dOYW1lKSB7XG4gIHJldHVybiB3aW5kb3dOYW1lID09PSBDSFJPTUlVTV9XSU47XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdfQ==