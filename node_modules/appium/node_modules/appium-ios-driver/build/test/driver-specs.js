require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _this = this;

var _ = require('../');

var _2 = _interopRequireDefault(_);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumTestSupport = require('appium-test-support');

var _teen_process = require('teen_process');

var teen_process = _interopRequireWildcard(_teen_process);

var _appiumSupport = require('appium-support');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('driver', function () {
  it('should instantiate class', function () {
    var driver = new _2['default']();
    driver.should.exist;
  });

  describe('timeouts', function () {
    var driver = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            driver = new _2['default']();
            // await driver.createSession({});

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    describe('command', function () {
      it('should exist by default', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              driver.newCommandTimeoutMs.should.equal(60000);

            case 1:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
      it('should be settable through `timeouts`', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.timeouts('command', 20));

            case 2:
              driver.newCommandTimeoutMs.should.equal(20);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('implicit', function () {
      it('should not exist by default', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              driver.implicitWaitMs.should.equal(0);

            case 1:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
      it('should be settable through `timeouts`', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.timeouts('implicit', 20));

            case 2:
              driver.implicitWaitMs.should.equal(20);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('page load', function () {
      it('should be settable through `timeouts`', function callee$3$0() {
        var to;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              to = driver.pageLoadMs;
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(driver.timeouts('page load', to + 20));

            case 3:
              driver.pageLoadMs.should.equal(to + 20);

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
    describe('script', function () {
      it('should be settable through `timeouts`', function callee$3$0() {
        var to;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              to = driver.asyncWaitMs;
              context$4$0.next = 3;
              return _regeneratorRuntime.awrap(driver.timeouts('script', to + 20));

            case 3:
              driver.asyncWaitMs.should.equal(to + 20);

            case 4:
            case 'end':
              return context$4$0.stop();
          }
        }, null, _this);
      });
    });
  });
});

describe('getDeviceTime', (0, _appiumTestSupport.withMocks)({ fs: _appiumSupport.fs, teen_process: teen_process }, function (mocks) {
  it('should call idevicedate on real device', function callee$1$0() {
    var udid, date, idevicedatePath, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';
          date = new Date().toString();
          idevicedatePath = '/path/to/idevicedate';

          mocks.fs.expects('which').once().returns(idevicedatePath);
          mocks.teen_process.expects('exec').once().withExactArgs(idevicedatePath, ['-u', udid]).returns({ stdout: date });
          driver = new _2['default']();

          driver.opts = { udid: udid };

          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(driver.getDeviceTime());

        case 9:
          context$2$0.t0 = date;
          context$2$0.sent.should.equal(context$2$0.t0);

          mocks.fs.verify();
          mocks.teen_process.verify();

        case 13:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw an error when idevicedate cannot be found', function callee$1$0() {
    var udid, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';

          mocks.fs.expects('which').once().throws();
          driver = new _2['default']();

          driver.opts = { udid: udid };
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(driver.getDeviceTime().should.eventually.be.rejectedWith("Could not capture device date and time"));

        case 6:

          mocks.fs.verify();

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw an error when idevicedate fails', function callee$1$0() {
    var udid, idevicedatePath, driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          udid = 'some-udid';
          idevicedatePath = '/path/to/idevicedate';

          mocks.fs.expects('which').once().returns(idevicedatePath);
          mocks.teen_process.expects("exec").once().withExactArgs(idevicedatePath, ['-u', udid]).throws("ENOENT");
          driver = new _2['default']();

          driver.opts = { udid: udid };
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(driver.getDeviceTime().should.eventually.be.rejectedWith("Could not capture device date and time"));

        case 8:

          mocks.fs.verify();
          mocks.teen_process.verify();

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should return system date on simulator', function callee$1$0() {
    var driver;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          mocks.teen_process.expects("exec").never();
          driver = new _2['default']();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(driver.getDeviceTime());

        case 4:
          context$2$0.t0 = context$2$0.sent.should.be.an;
          context$2$0.t1 = String;
          context$2$0.t0 instanceof context$2$0.t1;

          mocks.teen_process.verify();

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
}));
//# sourceMappingURL=data:application/json;base64,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LEtBQUssRUFBRSxDQUFDO0FBQ1AsZ0JBQU0sR0FBRyxtQkFBZTs7MkNBQ3JCLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Ozs0Q0FBRSxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUU7MkJBQVksTUFBTTs7O0FBRTdELGVBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7Ozs7Ozs7R0FDN0IsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9kcml2ZXItc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0IElvc0RyaXZlciBmcm9tICcuLi8nO1xuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgeyB3aXRoTW9ja3MgfSBmcm9tICdhcHBpdW0tdGVzdC1zdXBwb3J0JztcbmltcG9ydCAqIGFzIHRlZW5fcHJvY2VzcyBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdkcml2ZXInLCAoKSA9PiB7XG4gIGl0KCdzaG91bGQgaW5zdGFudGlhdGUgY2xhc3MnLCAoKSA9PiB7XG4gICAgbGV0IGRyaXZlciA9IG5ldyBJb3NEcml2ZXIoKTtcbiAgICBkcml2ZXIuc2hvdWxkLmV4aXN0O1xuICB9KTtcblxuICBkZXNjcmliZSgndGltZW91dHMnLCAoKSA9PiB7XG4gICAgbGV0IGRyaXZlcjtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgZHJpdmVyID0gbmV3IElvc0RyaXZlcigpO1xuICAgICAgLy8gYXdhaXQgZHJpdmVyLmNyZWF0ZVNlc3Npb24oe30pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCdjb21tYW5kJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBleGlzdCBieSBkZWZhdWx0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBkcml2ZXIubmV3Q29tbWFuZFRpbWVvdXRNcy5zaG91bGQuZXF1YWwoNjAwMDApO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIGJlIHNldHRhYmxlIHRocm91Z2ggYHRpbWVvdXRzYCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgZHJpdmVyLnRpbWVvdXRzKCdjb21tYW5kJywgMjApO1xuICAgICAgICBkcml2ZXIubmV3Q29tbWFuZFRpbWVvdXRNcy5zaG91bGQuZXF1YWwoMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ2ltcGxpY2l0JywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBub3QgZXhpc3QgYnkgZGVmYXVsdCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgZHJpdmVyLmltcGxpY2l0V2FpdE1zLnNob3VsZC5lcXVhbCgwKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBiZSBzZXR0YWJsZSB0aHJvdWdoIGB0aW1lb3V0c2AnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGRyaXZlci50aW1lb3V0cygnaW1wbGljaXQnLCAyMCk7XG4gICAgICAgIGRyaXZlci5pbXBsaWNpdFdhaXRNcy5zaG91bGQuZXF1YWwoMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ3BhZ2UgbG9hZCcsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgYmUgc2V0dGFibGUgdGhyb3VnaCBgdGltZW91dHNgJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgdG8gPSBkcml2ZXIucGFnZUxvYWRNcztcbiAgICAgICAgYXdhaXQgZHJpdmVyLnRpbWVvdXRzKCdwYWdlIGxvYWQnLCB0byArIDIwKTtcbiAgICAgICAgZHJpdmVyLnBhZ2VMb2FkTXMuc2hvdWxkLmVxdWFsKHRvICsgMjApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgZGVzY3JpYmUoJ3NjcmlwdCcsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgYmUgc2V0dGFibGUgdGhyb3VnaCBgdGltZW91dHNgJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgdG8gPSBkcml2ZXIuYXN5bmNXYWl0TXM7XG4gICAgICAgIGF3YWl0IGRyaXZlci50aW1lb3V0cygnc2NyaXB0JywgdG8gKyAyMCk7XG4gICAgICAgIGRyaXZlci5hc3luY1dhaXRNcy5zaG91bGQuZXF1YWwodG8gKyAyMCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2dldERldmljZVRpbWUnLCB3aXRoTW9ja3Moe2ZzLCB0ZWVuX3Byb2Nlc3N9LCAobW9ja3MpID0+IHtcbiAgaXQoJ3Nob3VsZCBjYWxsIGlkZXZpY2VkYXRlIG9uIHJlYWwgZGV2aWNlJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCB1ZGlkID0gJ3NvbWUtdWRpZCc7XG4gICAgbGV0IGRhdGUgPSBuZXcgRGF0ZSgpLnRvU3RyaW5nKCk7XG4gICAgbGV0IGlkZXZpY2VkYXRlUGF0aCA9ICcvcGF0aC90by9pZGV2aWNlZGF0ZSc7XG4gICAgbW9ja3MuZnMuZXhwZWN0cygnd2hpY2gnKVxuICAgICAgLm9uY2UoKS5yZXR1cm5zKGlkZXZpY2VkYXRlUGF0aCk7XG4gICAgbW9ja3MudGVlbl9wcm9jZXNzLmV4cGVjdHMoJ2V4ZWMnKVxuICAgICAgLm9uY2UoKS53aXRoRXhhY3RBcmdzKGlkZXZpY2VkYXRlUGF0aCwgWyctdScsIHVkaWRdKVxuICAgICAgLnJldHVybnMoe3N0ZG91dDogZGF0ZX0pO1xuICAgIGxldCBkcml2ZXIgPSBuZXcgSW9zRHJpdmVyKCk7XG4gICAgZHJpdmVyLm9wdHMgPSB7dWRpZH07XG5cbiAgICAoYXdhaXQgZHJpdmVyLmdldERldmljZVRpbWUoKSkuc2hvdWxkLmVxdWFsKGRhdGUpO1xuXG4gICAgbW9ja3MuZnMudmVyaWZ5KCk7XG4gICAgbW9ja3MudGVlbl9wcm9jZXNzLnZlcmlmeSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIHdoZW4gaWRldmljZWRhdGUgY2Fubm90IGJlIGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCB1ZGlkID0gJ3NvbWUtdWRpZCc7XG4gICAgbW9ja3MuZnMuZXhwZWN0cygnd2hpY2gnKVxuICAgICAgLm9uY2UoKS50aHJvd3MoKTtcbiAgICBsZXQgZHJpdmVyID0gbmV3IElvc0RyaXZlcigpO1xuICAgIGRyaXZlci5vcHRzID0ge3VkaWR9O1xuICAgIGF3YWl0IGRyaXZlci5nZXREZXZpY2VUaW1lKClcbiAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoXCJDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZVwiKTtcblxuICAgIG1vY2tzLmZzLnZlcmlmeSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIHdoZW4gaWRldmljZWRhdGUgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHVkaWQgPSAnc29tZS11ZGlkJztcbiAgICBsZXQgaWRldmljZWRhdGVQYXRoID0gJy9wYXRoL3RvL2lkZXZpY2VkYXRlJztcbiAgICBtb2Nrcy5mcy5leHBlY3RzKCd3aGljaCcpXG4gICAgICAub25jZSgpLnJldHVybnMoaWRldmljZWRhdGVQYXRoKTtcbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgIC5vbmNlKCkud2l0aEV4YWN0QXJncyhpZGV2aWNlZGF0ZVBhdGgsIFsnLXUnLCB1ZGlkXSlcbiAgICAgIC50aHJvd3MoXCJFTk9FTlRcIik7XG4gICAgbGV0IGRyaXZlciA9IG5ldyBJb3NEcml2ZXIoKTtcbiAgICBkcml2ZXIub3B0cyA9IHt1ZGlkfTtcbiAgICBhd2FpdCBkcml2ZXIuZ2V0RGV2aWNlVGltZSgpXG4gICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKFwiQ291bGQgbm90IGNhcHR1cmUgZGV2aWNlIGRhdGUgYW5kIHRpbWVcIik7XG5cbiAgICBtb2Nrcy5mcy52ZXJpZnkoKTtcbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MudmVyaWZ5KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHN5c3RlbSBkYXRlIG9uIHNpbXVsYXRvcicsIGFzeW5jICgpID0+IHtcbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgIC5uZXZlcigpO1xuICAgIGxldCBkcml2ZXIgPSBuZXcgSW9zRHJpdmVyKCk7XG4gICAgKGF3YWl0IGRyaXZlci5nZXREZXZpY2VUaW1lKCkpLnNob3VsZC5iZS5hbiBpbnN0YW5jZW9mKFN0cmluZyk7XG5cbiAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MudmVyaWZ5KCk7XG4gIH0pO1xufSkpO1xuIl19